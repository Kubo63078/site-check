<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ì„¸ì´ë²„ìŠ¤ ë¦¬ì•¡í„° ì„¤ì¹˜ í†µí•© ì¡°ì‚¬ ì‹œìŠ¤í…œ v5.0 - Dynamic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            height: 100vh;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content-area {
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .mobile-menu-container {
            display: none;
            position: relative;
        }

        .hamburger-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .hamburger-btn span {
            display: block;
            width: 20px;
            height: 2px;
            background: white;
            margin: 2px 0;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .mobile-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .mobile-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .mobile-menu-btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            text-align: left;
            color: #333;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .mobile-menu-btn:last-child {
            border-bottom: none;
        }

        .mobile-menu-btn:hover {
            background: #f8f9ff;
        }

        .mobile-menu-btn:first-child {
            border-radius: 8px 8px 0 0;
        }

        .mobile-menu-btn:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* íŠ¸ë¦¬ ë·° ì»¨í…Œì´ë„ˆ */
        .tree-view-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .tree-view-container.active {
            display: block;
        }

        /* íŠ¸ë¦¬ êµ¬ì¡° ìŠ¤íƒ€ì¼ */
        .tree-diagram {
            border-radius: 15px;
            padding: 30px;
            position: relative;
            overflow-x: auto;
            overflow-y: visible;
            transform-origin: top left;
            transition: transform 0.3s ease;
            display: inline-block;
            min-width: 100%;
        }

        /* íŠ¸ë¦¬ ë‹¤ì´ì–´ê·¸ë¨ ë°°ê²½ ì»¨í…Œì´ë„ˆ */
        .tree-view-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin: 20px;
        }

        .tree-node {
            position: relative;
            display: inline-block;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .tree-node:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            background: #f8f9ff;
        }

        .tree-node.selected {
            background: #667eea;
            color: white;
            border-color: #764ba2;
        }

        .tree-node.selected .node-status,
        .tree-node.selected .node-actions {
            background: white;
            color: #667eea;
        }

        .tree-node.add-node {
            border: 2px dashed #999;
            background: #f9f9f9;
            opacity: 0.7;
        }

        .tree-node.add-node:hover {
            opacity: 1;
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .node-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .node-info {
            font-size: 12px;
            opacity: 0.8;
        }
        .node-info.missing {
            color: #f44336;
            font-weight: bold;
        }

        .node-status {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .node-status.incomplete {
            background: #ff9800;
        }

        .node-status.empty {
            background: #e0e0e0;
        }

        /* ì‚¬ì§„ í‘œì‹œ ì˜ì—­ */
        .node-photos {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 140px;
        }

        .node-photos img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .node-photos img:hover {
            transform: scale(1.1);
        }

        /* ì‚¬ì§„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .photo-btn {
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.2s;
        }

        .photo-btn:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }

        /* ë…¸ë“œ ì•¡ì…˜ ë²„íŠ¼ */
        .node-actions {
            position: absolute;
            top: -10px;
            left: -10px;
            display: none;
            gap: 5px;
        }

        .tree-node:hover .node-actions {
            display: flex;
        }

        .node-action-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .node-action-btn.delete {
            background: #f44336;
            color: white;
        }

        .node-action-btn.edit {
            background: #2196F3;
            color: white;
        }

        .node-action-btn:hover {
            transform: scale(1.2);
        }

        /* íŠ¸ë¦¬ ê³„ì¸µ êµ¬ì¡° */
        .tree-level {
            display: flex;
            justify-content: center;
            margin: 40px 0;
            position: relative;
            flex-wrap: nowrap;
            gap: 20px;
            min-width: max-content;
        }

        .tree-level-1 {
            justify-content: center;
        }

        .tree-level-2 {
            justify-content: center;
            padding: 0 50px;
        }

        .tree-level-3 {
            justify-content: center;
            padding: 0 30px;
        }

        .tree-level-4 {
            justify-content: center;
            padding: 0 20px;
        }

        /* ìƒì„¸ ì •ë³´ íŒ¨ë„ */
        .detail-panel {
            position: fixed;
            right: -450px;
            top: 0;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-header h2 {
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .close-btn:hover {
            transform: rotate(90deg);
        }

        .detail-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 0;
            overflow-y: auto;
        }

        .detail-footer {
            background: white;
            padding: 20px;
            padding-bottom: 50px;
            /* iOS safe area ëŒ€ì‘ */
            padding-bottom: calc(50px + env(safe-area-inset-bottom));
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .detail-form-group {
            margin-bottom: 20px;
        }

        .detail-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .detail-form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .detail-form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }


        /* SVG ì—°ê²°ì„  ìŠ¤íƒ€ì¼ */
        .tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .tree-path {
            fill: none;
            stroke: #667eea;
            stroke-width: 2;
            opacity: 0.5;
        }

        .tree-path.highlighted {
            stroke: #e94560;
            stroke-width: 3;
            opacity: 1;
        }

        /* íˆ´íŒ */
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip.show {
            opacity: 1;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {

            .content-area {
                order: 1;
                height: calc(100vh - 60px);
            }

            .header {
                padding: 15px 20px;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .header h1 {
                font-size: 18px;
            }

            /* ê¸°ì¡´ ë²„íŠ¼ë“¤ ìˆ¨ê¹€ */
            .header-actions {
                display: none;
            }

            /* í–„ë²„ê±° ë©”ë‰´ í‘œì‹œ */
            .mobile-menu-container {
                display: block;
            }

            .tree-view-container {
                padding: 15px;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .tree-node {
                padding: 12px 15px;
                margin: 8px;
                min-width: 120px;
            }

            .node-title {
                font-size: 14px;
            }

            .node-info {
                font-size: 12px;
            }

            .node-photos img {
                width: 30px;
                height: 30px;
            }

            .detail-panel {
                right: -100%;
                width: 100%;
                top: 0;
            }

            .detail-panel.open {
                right: 0;
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
                margin: 20px auto;
            }

            .photo-btn {
                padding: 8px 12px;
                font-size: 14px;
                width: 100%;
                margin: 8px 0;
            }

            /* í„°ì¹˜ ì¹œí™”ì  ë²„íŠ¼ í¬ê¸° */
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }

            .header-btn {
                min-height: 40px;
                touch-action: manipulation;
            }

            .tree-node {
                touch-action: manipulation;
                min-height: 60px;
            }

            /* í™•ëŒ€ëœ í…ìŠ¤íŠ¸ ì…ë ¥ */
            .detail-form-control {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                padding: 12px;
                min-height: 44px;
            }

            /* ì‚¬ì§„ í™•ëŒ€ */
            .node-photos img:hover {
                transform: scale(1.2);
            }
        }

        /* ì•„ì£¼ ì‘ì€ í™”ë©´ (320px ì´í•˜) */
        @media (max-width: 320px) {
            .header h1 {
                font-size: 16px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .tree-node {
                min-width: 100px;
                padding: 10px 12px;
            }

            .header-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */
        .confirm-dialog {
            position: absolute;
            background: white;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
        }

        .confirm-dialog.show {
            display: block;
        }

        .confirm-dialog p {
            margin-bottom: 15px;
            font-size: 14px;
        }

        .confirm-dialog .buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirm-dialog button {
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ì—…ì²´ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #companyInfoModal .modal-body label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        #companyInfoModal .modal-body input,
        #companyInfoModal .modal-body textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        #companyInfoModal .modal-body textarea {
            height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        #companyInfoModal .modal-body input:first-of-type {
            margin-top: 0;
        }

        #companyInfoModal .modal-body input:focus,
        #companyInfoModal .modal-body textarea:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .detail-panel {
                width: 100%;
                right: -100%;
            }

            .detail-footer {
                padding-bottom: 60px;
                /* iOS safe area ëŒ€ì‘ ê°•í™” */
                padding-bottom: calc(60px + env(safe-area-inset-bottom));
            }

            .detail-footer .btn {
                padding: 15px 20px;
                font-size: 16px;
                min-height: 50px;
            }

            .tree-level {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .tree-level::-webkit-scrollbar {
                height: 4px;
            }

            .tree-level::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.3);
                border-radius: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <!-- í—¤ë” -->
            <div class="header">
                <div>
                    <h1>ğŸ“‹ í˜„ì¥ì¡°ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openCompanyInfo()">ğŸ“‹ ê¸°ë³¸ì •ë³´</button>
                    <button class="header-btn" onclick="importData()">ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="header-btn" onclick="exportData()">ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°</button>
                    <button class="header-btn" onclick="generatePhotoIndex()">ğŸ“· ì‚¬ì§„ ëŒ€ì¡°í‘œ</button>
                </div>

                <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ -->
                <div class="mobile-menu-container">
                    <button class="hamburger-btn" onclick="toggleMobileMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
                        <button class="mobile-menu-btn" onclick="openCompanyInfo(); closeMobileMenu()">ğŸ“‹ ê¸°ë³¸ì •ë³´</button>
                        <button class="mobile-menu-btn" onclick="importData(); closeMobileMenu()">ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="mobile-menu-btn" onclick="exportData(); closeMobileMenu()">ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°</button>
                        <button class="mobile-menu-btn" onclick="generatePhotoIndex(); closeMobileMenu()">ğŸ“· ì‚¬ì§„ ëŒ€ì¡°í‘œ</button>
                    </div>
                </div>
            </div>

            <!-- íŠ¸ë¦¬ ë·° ì»¨í…Œì´ë„ˆ -->
            <div class="tree-view-container active" id="treeView">


                <!-- ì „ì²´ êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨ -->
                <div class="structure-overview">
                    <h2 class="structure-title" style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333;">
                        ğŸŒ³ ì „ë ¥ê³„í†µ
                    </h2>
                    
                    <div class="tree-diagram" id="treeDiagram">
                        <!-- SVG ìº”ë²„ìŠ¤ -->
                        <svg class="tree-svg" id="treeSvg"></svg>
                        
                        <!-- Level 1: í•œì „ ìˆ˜ì „ -->
                        <div class="tree-level tree-level-1" id="level1">
                            <div class="tree-node" id="kepco" onclick="showNodeDetail('kepco')" style="background: #f3e5f5;">
                                <div class="node-title">ğŸ­ í•œì „ ìˆ˜ì „</div>
                                <div class="node-info">22.9kV / 0kW</div>
                                <div class="node-status empty">-</div>
                                <div class="node-photos" id="photos-kepco"></div>
                            </div>
                        </div>

                        <!-- Level 2: ë³€ì••ê¸° -->
                        <div class="tree-level tree-level-2" id="level2">
                            <!-- ë³€ì••ê¸° ì¶”ê°€ ë²„íŠ¼ -->
                            <div class="tree-node add-node" onclick="addTransformer()">
                                <div class="node-title">â• ë³€ì••ê¸° ì¶”ê°€</div>
                                <div class="node-info">í´ë¦­í•˜ì—¬ ì¶”ê°€</div>
                            </div>
                        </div>

                        <!-- Level 3: ë¶„ì „ë°˜ -->
                        <div class="tree-level tree-level-3" id="level3">
                            <!-- MCC ì¶”ê°€ ë²„íŠ¼ -->
                            <div class="tree-node add-node" onclick="addMCC()">
                                <div class="node-title">â• ë¶„ì „ë°˜ ì¶”ê°€</div>
                                <div class="node-info">ë³€ì••ê¸° ì„ íƒ í›„ ì¶”ê°€</div>
                            </div>
                        </div>

                        <!-- Level 4: ì£¼ìš” ë¶€í•˜ -->
                        <div class="tree-level tree-level-4" id="level4">
                            <!-- ë¶€í•˜ ì¶”ê°€ ë²„íŠ¼ -->
                            <div class="tree-node add-node" onclick="addLoad()">
                                <div class="node-title">â• ë¶€í•˜ ì¶”ê°€</div>
                                <div class="node-info">ë¶„ì „ë°˜ ì„ íƒ í›„ ì¶”ê°€</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ì •ë³´ íŒ¨ë„ -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-header">
                <h2 id="detailTitle">ìƒì„¸ ì •ë³´</h2>
                <button class="close-btn" onclick="closeDetail()">Ã—</button>
            </div>
            <div class="detail-content" id="detailContent">
                <!-- ë™ì  ì½˜í…ì¸  -->
            </div>
        </div>


        <!-- ì¶”ê°€ ëª¨ë‹¬ -->
        <div class="modal" id="addModal">
            <div class="modal-content">
                <div class="modal-header" id="modalTitle">í•­ëª© ì¶”ê°€</div>
                <div class="modal-body" id="modalBody">
                    <!-- ë™ì  ì½˜í…ì¸  -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="confirmAdd()">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
        <div class="confirm-dialog" id="deleteConfirm">
            <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="buttons">
                <button onclick="cancelDelete()" style="background: #e0e0e0;">ì·¨ì†Œ</button>
                <button onclick="confirmDelete()" style="background: #f44336; color: white;">ì‚­ì œ</button>
            </div>
        </div>

        <!-- ì—…ì²´ì •ë³´ ëª¨ë‹¬ -->
        <div class="modal" id="companyInfoModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>ğŸ“‹ ì—…ì²´ ê¸°ë³¸ì •ë³´</h3>
                    <span class="close" onclick="closeCompanyInfo()">&times;</span>
                </div>
                <div class="modal-body" id="companyInfoBody">
                    <label>ì—…ì²´ëª…</label>
                    <input type="text" id="companyName" placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">

                    <label>ì£¼ì†Œ</label>
                    <input type="text" id="companyAddress" placeholder="ì—…ì²´ ì£¼ì†Œ">

                    <label>ì—°ë½ì²˜</label>
                    <input type="text" id="companyContact" placeholder="ì „í™”ë²ˆí˜¸">

                    <label>ë‹´ë‹¹ì</label>
                    <input type="text" id="companyManager" placeholder="ë‹´ë‹¹ìëª…">

                    <label>ì¡°ì‚¬ì¼ì</label>
                    <input type="date" id="surveyDate">

                    <label>ê³„ì•½ì¼ì</label>
                    <input type="date" id="contractDate">

                    <label>ë¹„ê³ </label>
                    <textarea id="companyNotes" placeholder="ê¸°íƒ€ ë©”ëª¨"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCompanyInfo()">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="saveCompanyInfo()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let systemData = {
            companyInfo: {
                name: '',
                address: '',
                contact: '',
                manager: '',
                surveyDate: '',
                contractDate: '',
                notes: ''
            },
            kepco: {
                voltage: '22.9kV',
                contractPower: 0,
                receptionType: '',
                vcb: '',
                status: 'empty'
            },
            transformers: {},
            panels: {},
            loads: {},
            images: {}, // ì‚¬ì§„ ì €ì¥ìš© (nodeId: [base64Images...])
            connections: {
                transformerToPanels: {},
                panelToLoads: {}
            }
        };

        // ì¹´ìš´í„°
        let transformerCounter = 0;
        let mccCounter = 0;
        let loadCounter = 0;

        // ì„ íƒëœ í•­ëª©
        let selectedNode = null;
        let selectedTransformer = null;
        let selectedPanel = null;
        let nodeToDelete = null;
        let currentModalType = null;

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getTransformerNumber(transformerId) {
            // transformer1 -> 1
            return parseInt(transformerId.replace('transformer', ''));
        }

        function getPanelNumbers(panelTitle) {
            // ë¶„ì „1-2 -> [1, 2]
            const match = panelTitle.match(/ë¶„ì „(\d+)-(\d+)/);
            return match ? [parseInt(match[1]), parseInt(match[2])] : [0, 0];
        }

        function getLoadNumbers(loadTitle) {
            // ë¶€í•˜1-2-3 -> [1, 2, 3]
            const match = loadTitle.match(/ë¶€í•˜(\d+)-(\d+)-(\d+)/);
            return match ? [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])] : [0, 0, 0];
        }

        function sortNodesByNumber(container, getNumbers) {
            const nodes = Array.from(container.children).filter(node => !node.classList.contains('add-node'));
            const addButton = container.querySelector('.add-node');

            // ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            nodes.sort((a, b) => {
                const aData = systemData.transformers[a.id] || systemData.panels[a.id] || systemData.loads[a.id];
                const bData = systemData.transformers[b.id] || systemData.panels[b.id] || systemData.loads[b.id];

                const aNumbers = getNumbers(aData.title);
                const bNumbers = getNumbers(bData.title);

                // ë°°ì—´ ë¹„êµ (ì²« ë²ˆì§¸ ìš”ì†Œë¶€í„° ìˆœì„œëŒ€ë¡œ)
                for (let i = 0; i < Math.max(aNumbers.length, bNumbers.length); i++) {
                    const aNum = aNumbers[i] || 0;
                    const bNum = bNumbers[i] || 0;
                    if (aNum !== bNum) return aNum - bNum;
                }
                return 0;
            });

            // DOMì—ì„œ ê¸°ì¡´ ë…¸ë“œë“¤ ì œê±°
            nodes.forEach(node => container.removeChild(node));

            // ì •ë ¬ëœ ìˆœì„œë¡œ ë‹¤ì‹œ ì¶”ê°€
            nodes.forEach(node => container.insertBefore(node, addButton));
        }

        // ë³€ì••ê¸° ì¶”ê°€
        function addTransformer() {
            transformerCounter++;
            const trId = 'transformer' + transformerCounter;

            // ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€ì••ê¸° ì¶”ê°€
            systemData.transformers[trId] = {
                id: trId,
                title: `ë³€ì••ê¸°${transformerCounter}`,
                name: `ì£¼ë³€ì••ê¸° #${transformerCounter}`,
                capacity: 1500,
                primaryVoltage: 22900,
                secondaryVoltage: '380/220',
                type: 'Oil',
                loadRate: 0,
                status: 'empty'
            };

            // DOMì— ë…¸ë“œ ì¶”ê°€
            addTransformerNode(trId);
            updateStatistics();
            redrawConnections();

            // ìë™ ìŠ¤ì¼€ì¼ ì¡°ì •
            setTimeout(() => {
                autoScaleTree();
            }, 100);
        }

        // MCC ì¶”ê°€
        function addMCC() {
            // ë³€ì••ê¸°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (Object.keys(systemData.transformers).length === 0) {
                alert('ë¨¼ì € ë³€ì••ê¸°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë³€ì••ê¸°ê°€ 1ê°œë©´ ìë™ ì—°ê²°, ì—¬ëŸ¬ ê°œë©´ ì„ íƒ
            const transformerIds = Object.keys(systemData.transformers);
            if (transformerIds.length === 1) {
                // ë³€ì••ê¸°ê°€ 1ê°œë©´ ë°”ë¡œ ì¶”ê°€
                addMCCToTransformer(transformerIds[0]);
            } else {
                // ë³€ì••ê¸°ê°€ ì—¬ëŸ¬ ê°œë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                showTransformerSelectionModal();
            }
        }

        function showTransformerSelectionModal() {
            // ì„ íƒ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 400px;
                width: 90%;
            `;

            let html = '<h3>ì—°ê²°í•  ë³€ì••ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3><div style="margin: 15px 0;">';

            Object.keys(systemData.transformers).forEach(trId => {
                const tr = systemData.transformers[trId];
                html += `
                    <button style="
                        display: block;
                        width: 100%;
                        padding: 10px;
                        margin: 5px 0;
                        border: 1px solid #ddd;
                        background: #f9f9f9;
                        border-radius: 5px;
                        cursor: pointer;
                        text-align: left;
                    " onclick="selectTransformer('${trId}')">
                        ğŸ”Œ ${tr.title} (${tr.capacity}kVA)
                    </button>
                `;
            });

            html += `</div>
                <button style="
                    padding: 8px 16px;
                    background: #ccc;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    float: right;
                " onclick="closeSelectionModal()">ì·¨ì†Œ</button>
            `;

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
            window.currentSelectionModal = modal;
        }

        function selectTransformer(transformerId) {
            addMCCToTransformer(transformerId);
            closeSelectionModal();
        }

        function closeSelectionModal() {
            if (window.currentSelectionModal) {
                document.body.removeChild(window.currentSelectionModal);
                window.currentSelectionModal = null;
            }
        }

        function addMCCToTransformer(transformerId) {
            const transformerNumber = getTransformerNumber(transformerId);

            // í•´ë‹¹ ë³€ì••ê¸°ì— ì—°ê²°ëœ ê¸°ì¡´ ë¶„ì „ë°˜ ê°œìˆ˜ ê³„ì‚°
            const existingPanels = systemData.connections.transformerToPanels[transformerId] || [];
            const panelSequence = existingPanels.length + 1;

            mccCounter++;
            const mccId = 'mcc' + mccCounter;

            // ê³„ì¸µì  ë²ˆí˜¸ ì²´ê³„ë¡œ ë¶„ì „ë°˜ ì¶”ê°€ (X-Y í˜•ì‹)
            systemData.panels[mccId] = {
                id: mccId,
                title: `ë¶„ì „${transformerNumber}-${panelSequence}`,
                name: `MCC-${transformerNumber}-${panelSequence} ë™ë ¥ë°˜`,
                ratedCurrent: 2000,
                branches: 20,
                purpose: 'ë™ë ¥ë°˜',
                status: 'empty'
            };

            // ì—°ê²°ì •ë³´ ì—…ë°ì´íŠ¸
            if (!systemData.connections.transformerToPanels[transformerId]) {
                systemData.connections.transformerToPanels[transformerId] = [];
            }
            systemData.connections.transformerToPanels[transformerId].push(mccId);

            // DOMì— ë…¸ë“œ ì¶”ê°€
            addMCCNode(mccId);
            updateStatistics();
            redrawConnections();

            // ìë™ ìŠ¤ì¼€ì¼ ì¡°ì •
            setTimeout(() => {
                autoScaleTree();
            }, 100);
        }

        // ë¶€í•˜ ì¶”ê°€
        function addLoad() {
            // ë¶„ì „ë°˜ì´ ìˆëŠ”ì§€ í™•ì¸
            if (Object.keys(systemData.panels).length === 0) {
                alert('ë¨¼ì € ë¶„ì „ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¶„ì „ë°˜ì´ 1ê°œë©´ ìë™ ì—°ê²°, ì—¬ëŸ¬ ê°œë©´ ì„ íƒ
            const panelIds = Object.keys(systemData.panels);
            if (panelIds.length === 1) {
                // ë¶„ì „ë°˜ì´ 1ê°œë©´ ë°”ë¡œ ì¶”ê°€
                addLoadToPanel(panelIds[0]);
            } else {
                // ë¶„ì „ë°˜ì´ ì—¬ëŸ¬ ê°œë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                showPanelSelectionModal();
            }
        }

        function showPanelSelectionModal() {
            // ì„ íƒ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 400px;
                width: 90%;
            `;

            let html = '<h3>ì—°ê²°í•  ë¶„ì „ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</h3><div style="margin: 15px 0;">';

            Object.keys(systemData.panels).forEach(panelId => {
                const panel = systemData.panels[panelId];
                html += `
                    <button style="
                        display: block;
                        width: 100%;
                        padding: 10px;
                        margin: 5px 0;
                        border: 1px solid #ddd;
                        background: #f9f9f9;
                        border-radius: 5px;
                        cursor: pointer;
                        text-align: left;
                    " onclick="selectPanel('${panelId}')">
                        ğŸ“Š ${panel.title} (${panel.ratedCurrent}A)
                    </button>
                `;
            });

            html += `</div>
                <button style="
                    padding: 8px 16px;
                    background: #ccc;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    float: right;
                " onclick="closeSelectionModal()">ì·¨ì†Œ</button>
            `;

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
            window.currentSelectionModal = modal;
        }

        function selectPanel(panelId) {
            addLoadToPanel(panelId);
            closeSelectionModal();
        }

        function addLoadToPanel(panelId) {
            const panel = systemData.panels[panelId];
            const panelNumbers = getPanelNumbers(panel.title); // [ë³€ì••ê¸°ë²ˆí˜¸, ë¶„ì „ë°˜ë²ˆí˜¸]

            // í•´ë‹¹ ë¶„ì „ë°˜ì— ì—°ê²°ëœ ê¸°ì¡´ ë¶€í•˜ ê°œìˆ˜ ê³„ì‚°
            const existingLoads = systemData.connections.panelToLoads[panelId] || [];
            const loadSequence = existingLoads.length + 1;

            loadCounter++;
            const loadId = 'load' + loadCounter;

            // ê³„ì¸µì  ë²ˆí˜¸ ì²´ê³„ë¡œ ë¶€í•˜ ì¶”ê°€ (X-Y-Z í˜•ì‹)
            systemData.loads[loadId] = {
                id: loadId,
                title: `ë¶€í•˜${panelNumbers[0]}-${panelNumbers[1]}-${loadSequence}`,
                name: `ëƒ‰ë™ê¸°`,
                power: 500,
                quantity: 1,
                type: 'ì •ì „ì••ë¶€í•˜',
                operation: '24ì‹œê°„',
                status: 'empty'
            };

            // ì—°ê²°ì •ë³´ ì—…ë°ì´íŠ¸
            if (!systemData.connections.panelToLoads[panelId]) {
                systemData.connections.panelToLoads[panelId] = [];
            }
            systemData.connections.panelToLoads[panelId].push(loadId);

            // DOMì— ë…¸ë“œ ì¶”ê°€
            addLoadNode(loadId);
            updateStatistics();
            redrawConnections();

            // ìë™ ìŠ¤ì¼€ì¼ ì¡°ì •
            setTimeout(() => {
                autoScaleTree();
            }, 100);
        }

        // ì¶”ê°€ í™•ì¸
        function confirmAdd() {
            if (currentModalType === 'transformer') {
                const name = document.getElementById('newTrName').value || `ë³€ì••ê¸° #${transformerCounter + 1}`;
                const capacity = parseInt(document.getElementById('newTrCapacity').value) || 1000;
                const primaryV = parseInt(document.getElementById('newTrPrimaryV').value) || 22900;
                const secondaryV = document.getElementById('newTrSecondaryV').value;
                const type = document.getElementById('newTrType').value;
                
                transformerCounter++;
                const trId = `tr${transformerCounter}`;
                
                systemData.transformers[trId] = {
                    id: trId,
                    title: name,
                    capacity: capacity,
                    primaryVoltage: primaryV,
                    secondaryVoltage: secondaryV,
                    type: type,
                    loadRate: 0,
                    status: 'empty'
                };
                
                // DOMì— ë…¸ë“œ ì¶”ê°€
                addTransformerNode(trId);
                
            } else if (currentModalType === 'mcc') {
                const transformerId = document.getElementById('newMccTransformer').value;
                if (!transformerId) {
                    alert('ë³€ì••ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const name = document.getElementById('newMccName').value || `MCC-${mccCounter + 1}`;
                const breaker = parseInt(document.getElementById('newMccBreaker').value) || 1000;
                const branches = parseInt(document.getElementById('newMccBranches').value) || 10;
                const purpose = document.getElementById('newMccPurpose').value;
                
                mccCounter++;
                const mccId = `mcc${mccCounter}`;
                
                systemData.panels[mccId] = {
                    id: mccId,
                    title: name,
                    transformer: transformerId,
                    mainBreaker: breaker,
                    branches: branches,
                    purpose: purpose,
                    spareBranches: 0,
                    status: 'empty'
                };
                
                // ì—°ê²° ì •ë³´ ì €ì¥
                if (!systemData.connections.transformerToPanels[transformerId]) {
                    systemData.connections.transformerToPanels[transformerId] = [];
                }
                systemData.connections.transformerToPanels[transformerId].push(mccId);
                
                // DOMì— ë…¸ë“œ ì¶”ê°€
                addMCCNode(mccId);
                
            } else if (currentModalType === 'load') {
                const panelId = document.getElementById('newLoadPanel').value;
                if (!panelId) {
                    alert('ë¶„ì „ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const name = document.getElementById('newLoadName').value || `ë¶€í•˜ #${loadCounter + 1}`;
                const capacity = parseInt(document.getElementById('newLoadCapacity').value) || 100;
                const quantity = parseInt(document.getElementById('newLoadQuantity').value) || 1;
                const type = document.getElementById('newLoadType').value;
                const operation = document.getElementById('newLoadOperation').value;
                
                loadCounter++;
                const loadId = `load${loadCounter}`;
                
                systemData.loads[loadId] = {
                    id: loadId,
                    title: name,
                    panel: panelId,
                    capacity: capacity,
                    quantity: quantity,
                    type: type,
                    operationHours: operation,
                    loadRate: 80,
                    status: 'empty'
                };
                
                // ì—°ê²° ì •ë³´ ì €ì¥
                if (!systemData.connections.panelToLoads[panelId]) {
                    systemData.connections.panelToLoads[panelId] = [];
                }
                systemData.connections.panelToLoads[panelId].push(loadId);
                
                // DOMì— ë…¸ë“œ ì¶”ê°€
                addLoadNode(loadId);
            }
            
            closeModal();
            updateStatistics();
            redrawConnections();
        }

        // ë³€ì••ê¸° ë…¸ë“œ DOM ì¶”ê°€
        function addTransformerNode(trId) {
            const level2 = document.getElementById('level2');
            const addBtn = level2.querySelector('.add-node');

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.id = trId;
            node.onclick = () => openDetail(trId);

            const tr = systemData.transformers[trId];

            // ìš©ëŸ‰ ì •ë³´ í™•ì¸
            let capacityInfo = '';
            let capacityClass = '';
            if (tr.capacity && tr.capacity > 0) {
                capacityInfo = `${tr.capacity}kVA`;
            } else {
                capacityInfo = 'ìš©ëŸ‰ ë¯¸ì…ë ¥';
                capacityClass = ' missing';
            }

            node.innerHTML = `
                <div class="node-actions">
                    <button class="node-action-btn edit" onclick="event.stopPropagation(); openDetail('${trId}')">âœ</button>
                    <button class="node-action-btn delete" onclick="event.stopPropagation(); deleteNode('${trId}', 'transformer')">Ã—</button>
                </div>
                <div class="node-title">ğŸ”Œ ${tr.title}</div>
                <div class="node-info${capacityClass}">${capacityInfo}</div>
                <div class="node-status ${tr.status}">${tr.status === 'complete' ? 'âœ“' : tr.status === 'incomplete' ? '!' : '-'}</div>
            `;

            level2.insertBefore(node, addBtn);

            // ë³€ì••ê¸° ë…¸ë“œë“¤ì„ ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ ìë™ ì •ë ¬
            function getTransformerNumbers(title) {
                const match = title.match(/ë³€ì••ê¸°(\d+)/);
                return match ? [parseInt(match[1])] : [0];
            }
            sortNodesByNumber(level2, getTransformerNumbers);
        }

        // MCC ë…¸ë“œ DOM ì¶”ê°€
        function addMCCNode(mccId) {
            const level3 = document.getElementById('level3');
            const addBtn = level3.querySelector('.add-node');

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.id = mccId;
            node.onclick = () => openDetail(mccId);

            const mcc = systemData.panels[mccId];

            // ì£¼ì°¨ë‹¨ê¸° ì •ë³´ í™•ì¸
            let breakerInfo = '';
            let breakerClass = '';
            if (mcc.mainBreaker && mcc.mainBreaker.trim()) {
                breakerInfo = mcc.mainBreaker;
            } else {
                breakerInfo = 'ë¯¸ì…ë ¥';
                breakerClass = ' missing';
            }

            node.innerHTML = `
                <div class="node-actions">
                    <button class="node-action-btn edit" onclick="event.stopPropagation(); openDetail('${mccId}')">âœ</button>
                    <button class="node-action-btn delete" onclick="event.stopPropagation(); deleteNode('${mccId}', 'mcc')">Ã—</button>
                </div>
                <div class="node-title">ğŸ“Š ${mcc.title}</div>
                <div class="node-info${breakerClass}">ì£¼ì°¨ë‹¨ê¸°: ${breakerInfo}</div>
                <div class="node-status ${mcc.status}">${mcc.status === 'complete' ? 'âœ“' : mcc.status === 'incomplete' ? '!' : '-'}</div>
            `;

            level3.insertBefore(node, addBtn);

            // ë¶„ì „ë°˜ ë…¸ë“œë“¤ì„ ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ ìë™ ì •ë ¬
            sortNodesByNumber(level3, getPanelNumbers);
        }

        // ë¶€í•˜ ë…¸ë“œ DOM ì¶”ê°€
        function addLoadNode(loadId) {
            const level4 = document.getElementById('level4');
            const addBtn = level4.querySelector('.add-node');

            const node = document.createElement('div');
            node.className = 'tree-node';
            node.id = loadId;
            node.onclick = () => openDetail(loadId);

            const load = systemData.loads[loadId];

            // ìš©ëŸ‰ ì •ë³´ í™•ì¸
            let capacityInfo = '';
            let capacityClass = '';
            if (load.power && load.power > 0) {
                capacityInfo = `${load.power}kWÃ—${load.quantity || 1}`;
            } else {
                capacityInfo = 'ìš©ëŸ‰ ë¯¸ì…ë ¥';
                capacityClass = ' missing';
            }

            node.innerHTML = `
                <div class="node-actions">
                    <button class="node-action-btn edit" onclick="event.stopPropagation(); openDetail('${loadId}')">âœ</button>
                    <button class="node-action-btn delete" onclick="event.stopPropagation(); deleteNode('${loadId}', 'load')">Ã—</button>
                </div>
                <div class="node-title">âš™ï¸ ${load.title}</div>
                <div class="node-info${capacityClass}">${capacityInfo}</div>
                <div class="node-status ${load.status}">${load.status === 'complete' ? 'âœ“' : load.status === 'incomplete' ? '!' : '-'}</div>
            `;

            level4.insertBefore(node, addBtn);

            // ë¶€í•˜ ë…¸ë“œë“¤ì„ ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ ìë™ ì •ë ¬
            sortNodesByNumber(level4, getLoadNumbers);
        }

        // ë…¸ë“œ ì‚­ì œ
        function deleteNode(nodeId, type) {
            nodeToDelete = { id: nodeId, type: type };
            
            const dialog = document.getElementById('deleteConfirm');
            const node = document.getElementById(nodeId);
            
            // ë‹¤ì´ì–¼ë¡œê·¸ ìœ„ì¹˜ ì„¤ì •
            const rect = node.getBoundingClientRect();
            dialog.style.top = rect.top + 'px';
            dialog.style.left = (rect.left - 200) + 'px';
            
            dialog.classList.add('show');
        }

        // ì‚­ì œ í™•ì¸
        function confirmDelete() {
            if (!nodeToDelete) return;
            
            const { id, type } = nodeToDelete;
            
            if (type === 'transformer') {
                // ì—°ê²°ëœ MCCë“¤ë„ ì‚­ì œ
                const connectedPanels = systemData.connections.transformerToPanels[id] || [];
                connectedPanels.forEach(panelId => {
                    // ì—°ê²°ëœ ë¶€í•˜ë“¤ë„ ì‚­ì œ
                    const connectedLoads = systemData.connections.panelToLoads[panelId] || [];
                    connectedLoads.forEach(loadId => {
                        document.getElementById(loadId)?.remove();
                        delete systemData.loads[loadId];
                    });
                    delete systemData.connections.panelToLoads[panelId];
                    
                    document.getElementById(panelId)?.remove();
                    delete systemData.panels[panelId];
                });
                delete systemData.connections.transformerToPanels[id];
                
                delete systemData.transformers[id];
                
            } else if (type === 'mcc') {
                // ì—°ê²°ëœ ë¶€í•˜ë“¤ë„ ì‚­ì œ
                const connectedLoads = systemData.connections.panelToLoads[id] || [];
                connectedLoads.forEach(loadId => {
                    document.getElementById(loadId)?.remove();
                    delete systemData.loads[loadId];
                });
                delete systemData.connections.panelToLoads[id];
                
                // ë³€ì••ê¸° ì—°ê²° ì •ë³´ì—ì„œ ì œê±°
                Object.keys(systemData.connections.transformerToPanels).forEach(trId => {
                    const panels = systemData.connections.transformerToPanels[trId];
                    const index = panels.indexOf(id);
                    if (index > -1) {
                        panels.splice(index, 1);
                    }
                });
                
                delete systemData.panels[id];
                
            } else if (type === 'load') {
                // ë¶„ì „ë°˜ ì—°ê²° ì •ë³´ì—ì„œ ì œê±°
                Object.keys(systemData.connections.panelToLoads).forEach(panelId => {
                    const loads = systemData.connections.panelToLoads[panelId];
                    const index = loads.indexOf(id);
                    if (index > -1) {
                        loads.splice(index, 1);
                    }
                });
                
                delete systemData.loads[id];
            }
            
            // DOMì—ì„œ ì œê±°
            document.getElementById(id)?.remove();
            
            cancelDelete();
            updateStatistics();
            redrawConnections();
        }

        // ì‚­ì œ ì·¨ì†Œ
        function cancelDelete() {
            document.getElementById('deleteConfirm').classList.remove('show');
            nodeToDelete = null;
        }

        // showNodeDetail í•¨ìˆ˜ (openDetailì˜ ë³„ì¹­)
        function showNodeDetail(nodeId) {
            openDetail(nodeId);
        }

        // ìƒì„¸ ì •ë³´ ì—´ê¸°
        function openDetail(nodeId) {
            const panel = document.getElementById('detailPanel');
            const content = document.getElementById('detailContent');
            const title = document.getElementById('detailTitle');
            
            // ë…¸ë“œ ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('selected');
            });
            const currentNode = document.getElementById(nodeId);
            if (currentNode) {
                currentNode.classList.add('selected');
            }
            selectedNode = nodeId;
            
            let detailHTML = '';
            
            if (nodeId === 'kepco') {
                title.textContent = 'í•œì „ ìˆ˜ì „ ì„¤ë¹„';
                detailHTML = `
                    <div class="detail-form-group">
                        <label>ìˆ˜ì „ ì „ì••</label>
                        <select class="detail-form-control" id="kepcoVoltage">
                            <option>22.9kV</option>
                            <option>6.6kV</option>
                            <option>154kV</option>
                        </select>
                    </div>
                    <div class="detail-form-group">
                        <label>ê³„ì•½ì „ë ¥ (kW)</label>
                        <input type="number" class="detail-form-control" id="kepcoContract" value="${systemData.kepco.contractPower}">
                    </div>
                    <div class="detail-form-group">
                        <label>ìˆ˜ì „ ë°©ì‹</label>
                        <select class="detail-form-control" id="kepcoReception">
                            <option>ë‹¨ì¼ìˆ˜ì „</option>
                            <option>ì´ì¤‘ìˆ˜ì „</option>
                            <option>ë£¨í”„ìˆ˜ì „</option>
                        </select>
                    </div>
                    <div class="detail-form-group">
                        <label>VCB ì‚¬ì–‘</label>
                        <input type="text" class="detail-form-control" id="kepcoVCB" value="${systemData.kepco.vcb}" placeholder="ì˜ˆ: LS VL-25 / 1250A">
                    </div>
                    <div class="detail-form-group">
                        <label>í˜„ì¥ ì‚¬ì§„</label>
                        <button class="photo-btn" onclick="addPhoto('kepco')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                        <div class="node-photos" id="detail-photos-kepco" style="margin-top: 10px; max-width: 100%;"></div>
                    </div>
                `;
            } else if (nodeId.startsWith('tr')) {
                const tr = systemData.transformers[nodeId];
                if (!tr) return;
                
                title.textContent = tr.title;
                detailHTML = `
                    <div class="detail-form-group">
                        <label>ë³€ì••ê¸° ëª…ì¹­</label>
                        <input type="text" class="detail-form-control" id="editTrName" value="${tr.title}">
                    </div>
                    <div class="detail-form-group">
                        <label>ìš©ëŸ‰ (kVA)</label>
                        <input type="number" class="detail-form-control" id="editTrCapacity" value="${tr.capacity}">
                    </div>
                    <div class="detail-form-group">
                        <label>ë¶€í•˜ìœ¨ (%)</label>
                        <input type="number" class="detail-form-control" id="editTrLoadRate" value="${tr.loadRate}" min="0" max="100">
                    </div>
                    <div class="detail-form-group">
                        <label>ë³€ì••ê¸° íƒ€ì…</label>
                        <select class="detail-form-control" id="editTrType">
                            <option ${tr.type === 'Oil' ? 'selected' : ''}>Oil</option>
                            <option ${tr.type === 'Dry' ? 'selected' : ''}>Dry</option>
                            <option ${tr.type === 'Mold' ? 'selected' : ''}>Mold</option>
                        </select>
                    </div>
                    <div class="detail-form-group">
                        <label>ì œì¡°ì‚¬/ì œì¡°ë…„ë„</label>
                        <input type="text" class="detail-form-control" placeholder="ì˜ˆ: í˜„ëŒ€/2020">
                    </div>
                    <div class="detail-form-group">
                        <label>í˜„ì¥ ì‚¬ì§„</label>
                        <button class="photo-btn" onclick="addPhoto('${nodeId}')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                        <div class="node-photos" id="detail-photos-${nodeId}" style="margin-top: 10px; max-width: 100%;"></div>
                    </div>
                `;
            } else if (nodeId.startsWith('mcc')) {
                const mcc = systemData.panels[nodeId];
                if (!mcc) return;
                
                title.textContent = mcc.title;
                detailHTML = `
                    <div class="detail-form-group">
                        <label>ë¶„ì „ë°˜ ëª…ì¹­</label>
                        <input type="text" class="detail-form-control" id="editMccName" value="${mcc.title}">
                    </div>
                    <div class="detail-form-group">
                        <label>ì£¼ì°¨ë‹¨ê¸° (A)</label>
                        <input type="number" class="detail-form-control" id="editMccBreaker" value="${mcc.mainBreaker}">
                    </div>
                    <div class="detail-form-group">
                        <label>ì´ ë¶„ê¸° ìˆ˜</label>
                        <input type="number" class="detail-form-control" id="editMccBranches" value="${mcc.branches}">
                    </div>
                    <div class="detail-form-group">
                        <label>ì˜ˆë¹„ ë¶„ê¸°</label>
                        <input type="number" class="detail-form-control" value="${mcc.spareBranches || 0}">
                    </div>
                    <div class="detail-form-group">
                        <label>ë¦¬ì•¡í„° ì„¤ì¹˜ ê³µê°„</label>
                        <select class="detail-form-control">
                            <option>ì¶©ë¶„</option>
                            <option>ë³´í†µ</option>
                            <option>ë¶€ì¡±</option>
                        </select>
                    </div>
                    <div class="detail-form-group">
                        <label>í˜„ì¥ ì‚¬ì§„</label>
                        <button class="photo-btn" onclick="addPhoto('${nodeId}')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                        <div class="node-photos" id="detail-photos-${nodeId}" style="margin-top: 10px; max-width: 100%;"></div>
                    </div>
                `;
            } else if (nodeId.startsWith('load')) {
                const load = systemData.loads[nodeId];
                if (!load) return;
                
                title.textContent = load.title;
                detailHTML = `
                    <div class="detail-form-group">
                        <label>ë¶€í•˜ ëª…ì¹­</label>
                        <input type="text" class="detail-form-control" id="editLoadName" value="${load.title}">
                    </div>
                    <div class="detail-form-group">
                        <label>ë‹¨ìœ„ ìš©ëŸ‰ (kW)</label>
                        <input type="number" class="detail-form-control" id="editLoadCapacity" value="${load.capacity}">
                    </div>
                    <div class="detail-form-group">
                        <label>ìˆ˜ëŸ‰</label>
                        <input type="number" class="detail-form-control" id="editLoadQuantity" value="${load.quantity}">
                    </div>
                    <div class="detail-form-group">
                        <label>ë¶€í•˜ìœ¨ (%)</label>
                        <input type="number" class="detail-form-control" value="${load.loadRate}" min="0" max="100">
                    </div>
                    <div class="detail-form-group">
                        <label>ìš´ì „ ì‹œê°„</label>
                        <select class="detail-form-control">
                            <option ${load.operationHours === '24ì‹œê°„' ? 'selected' : ''}>24ì‹œê°„</option>
                            <option ${load.operationHours === 'ì£¼ê°„(8H)' ? 'selected' : ''}>ì£¼ê°„(8H)</option>
                            <option ${load.operationHours === '2êµëŒ€(16H)' ? 'selected' : ''}>2êµëŒ€(16H)</option>
                            <option ${load.operationHours === 'ê°„í—ì ' ? 'selected' : ''}>ê°„í—ì </option>
                        </select>
                    </div>
                    <div class="detail-form-group">
                        <label>í˜„ì¥ ì‚¬ì§„</label>
                        <button class="photo-btn" onclick="addPhoto('${nodeId}')">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                        <div class="node-photos" id="detail-photos-${nodeId}" style="margin-top: 10px; max-width: 100%;"></div>
                    </div>
                `;
            }
            
            content.innerHTML = detailHTML;

            // Footer ì˜ì—­ì— ì €ì¥ ë²„íŠ¼ ì¶”ê°€
            const footerHTML = `
                <button class="btn btn-success" style="width: 100%;" onclick="saveNodeData('${nodeId}')">
                    ğŸ’¾ ì €ì¥
                </button>
            `;

            // footerê°€ ì—†ìœ¼ë©´ ìƒì„±
            let footer = panel.querySelector('.detail-footer');
            if (!footer) {
                footer = document.createElement('div');
                footer.className = 'detail-footer';
                panel.appendChild(footer);
            }
            footer.innerHTML = footerHTML;

            panel.classList.add('open');

            // ìƒì„¸ íŒ¨ë„ì—ì„œ ì‚¬ì§„ í‘œì‹œ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateDetailPhotoDisplay(nodeId);
                redrawConnections(); // íŒ¨ë„ ì—´ë¦¼ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            }, 100);
        }

        // ë…¸ë“œ ë°ì´í„° ì €ì¥
        function saveNodeData(nodeId) {
            if (nodeId === 'kepco') {
                systemData.kepco.contractPower = parseInt(document.getElementById('kepcoContract').value) || 0;
                systemData.kepco.voltage = document.getElementById('kepcoVoltage').value;
                systemData.kepco.receptionType = document.getElementById('kepcoReception').value;
                systemData.kepco.vcb = document.getElementById('kepcoVCB').value;
                systemData.kepco.status = 'complete';
                
                // ë…¸ë“œ ì—…ë°ì´íŠ¸
                const node = document.getElementById('kepco');
                node.querySelector('.node-info').textContent = `${systemData.kepco.voltage} / ${systemData.kepco.contractPower}kW`;
                node.querySelector('.node-status').textContent = 'âœ“';
                node.querySelector('.node-status').className = 'node-status';
                
            } else if (nodeId.startsWith('tr')) {
                const tr = systemData.transformers[nodeId];
                tr.title = document.getElementById('editTrName').value;
                tr.capacity = parseInt(document.getElementById('editTrCapacity').value);
                tr.loadRate = parseInt(document.getElementById('editTrLoadRate').value);
                tr.type = document.getElementById('editTrType').value;
                tr.status = 'complete';
                
                // ë…¸ë“œ ì—…ë°ì´íŠ¸
                const node = document.getElementById(nodeId);
                node.querySelector('.node-title').textContent = `ğŸ”Œ ${tr.title}`;
                node.querySelector('.node-info').textContent = `${tr.capacity}kVA`;
                node.querySelector('.node-status').textContent = 'âœ“';
                node.querySelector('.node-status').className = 'node-status';
                
            } else if (nodeId.startsWith('mcc')) {
                const mcc = systemData.panels[nodeId];
                mcc.title = document.getElementById('editMccName').value;
                mcc.mainBreaker = parseInt(document.getElementById('editMccBreaker').value);
                mcc.branches = parseInt(document.getElementById('editMccBranches').value);
                mcc.status = 'complete';
                
                // ë…¸ë“œ ì—…ë°ì´íŠ¸
                const node = document.getElementById(nodeId);
                node.querySelector('.node-title').textContent = `ğŸ“Š ${mcc.title}`;
                node.querySelector('.node-status').textContent = 'âœ“';
                node.querySelector('.node-status').className = 'node-status';
                
            } else if (nodeId.startsWith('load')) {
                const load = systemData.loads[nodeId];
                load.title = document.getElementById('editLoadName').value;
                load.capacity = parseInt(document.getElementById('editLoadCapacity').value);
                load.quantity = parseInt(document.getElementById('editLoadQuantity').value);
                load.status = 'complete';
                
                // ë…¸ë“œ ì—…ë°ì´íŠ¸
                const node = document.getElementById(nodeId);
                node.querySelector('.node-title').textContent = `âš™ï¸ ${load.title}`;
                node.querySelector('.node-info').textContent = `${load.capacity}kWÃ—${load.quantity}`;
                node.querySelector('.node-status').textContent = 'âœ“';
                node.querySelector('.node-status').className = 'node-status';
            }
            
            closeDetail();
            updateStatistics();
        }

        // ìƒì„¸ íŒ¨ë„ ë‹«ê¸°
        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('open');
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('selected');
            });
            selectedNode = null;

            // íŒ¨ë„ ë‹«í˜ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            setTimeout(() => {
                redrawConnections();
            }, 300); // íŒ¨ë„ ë‹«í˜ ì• ë‹ˆë©”ì´ì…˜ ëŒ€ê¸°
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('addModal').classList.remove('show');
            currentModalType = null;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            // í†µê³„ ì¹´ë“œì™€ ì§„í–‰ë¥  ë°”ê°€ ì‚­ì œë˜ì–´ ë” ì´ìƒ ì—…ë°ì´íŠ¸í•  ìš”ì†Œê°€ ì—†ìŒ
            // ì´ í•¨ìˆ˜ëŠ” í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ë˜ ë‚´ìš©ì€ ë¹„ì›€
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            let completed = 0;
            let total = 1; // kepco
            
            if (systemData.kepco.status === 'complete') completed++;
            
            Object.values(systemData.transformers).forEach(tr => {
                total++;
                if (tr.status === 'complete') completed++;
            });
            
            Object.values(systemData.panels).forEach(panel => {
                total++;
                if (panel.status === 'complete') completed++;
            });
            
            Object.values(systemData.loads).forEach(load => {
                total++;
                if (load.status === 'complete') completed++;
            });
            
            // ì§„í–‰ë¥  ë°”ê°€ ì‚­ì œë˜ì–´ ë” ì´ìƒ ì—…ë°ì´íŠ¸í•  ìš”ì†Œê°€ ì—†ìŒ
        }

        // ìë™ ìŠ¤ì¼€ì¼ ì¡°ì • í•¨ìˆ˜
        function autoScaleTree() {
            const diagram = document.getElementById('treeDiagram');
            const container = diagram.parentElement;

            // ì‹¤ì œ ì½˜í…ì¸  ë„ˆë¹„ ê³„ì‚°
            const contentWidth = diagram.scrollWidth;
            const containerWidth = container.clientWidth - 40; // íŒ¨ë”© ê³ ë ¤

            if (contentWidth > containerWidth) {
                // í™”ë©´ì— ë§ì¶° ìë™ ìŠ¤ì¼€ì¼ ì ìš©
                const scale = Math.max(0.3, containerWidth / contentWidth);
                diagram.style.transform = `scale(${scale})`;

                // ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ìŠ¤ì¼€ì¼ëœ ì½˜í…ì¸ ì— ë§ì¶° ì¡°ì •
                const scaledWidth = contentWidth * scale;
                const scaledHeight = diagram.offsetHeight * scale;

                // ì»¨í…Œì´ë„ˆì˜ ì‹¤ì œ ê³µê°„ì„ ìŠ¤ì¼€ì¼ëœ í¬ê¸°ì— ë§ì¶¤
                container.style.height = `${scaledHeight + 60}px`; // íŒ¨ë”© ê³ ë ¤
                diagram.style.marginBottom = '0px';

                // ìŠ¤ì¼€ì¼ ë³€ê²½ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                setTimeout(() => redrawConnections(), 100);
            } else {
                diagram.style.transform = 'scale(1)';
                diagram.style.marginBottom = '0px';
                container.style.height = 'auto';

                // ìŠ¤ì¼€ì¼ ë¦¬ì…‹ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                setTimeout(() => redrawConnections(), 100);
            }
        }

        // ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        function redrawConnections() {
            const svg = document.getElementById('treeSvg');
            svg.innerHTML = '';
            
            // í•œì „ -> ë³€ì••ê¸°
            Object.keys(systemData.transformers).forEach(trId => {
                drawLine(svg, 'kepco', trId);
            });
            
            // ë³€ì••ê¸° -> ë¶„ì „ë°˜
            Object.keys(systemData.connections.transformerToPanels).forEach(trId => {
                const panels = systemData.connections.transformerToPanels[trId];
                panels.forEach(panelId => {
                    drawLine(svg, trId, panelId);
                });
            });
            
            // ë¶„ì „ë°˜ -> ë¶€í•˜
            Object.keys(systemData.connections.panelToLoads).forEach(panelId => {
                const loads = systemData.connections.panelToLoads[panelId];
                loads.forEach(loadId => {
                    drawLine(svg, panelId, loadId);
                });
            });
        }

        // ì„  ê·¸ë¦¬ê¸°
        function drawLine(svg, fromId, toId) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);

            if (!from || !to) return;

            // ë‹¤ì´ì–´ê·¸ë¨ê³¼ SVGì˜ í˜„ì¬ transform ìƒíƒœ ê³ ë ¤
            const diagram = document.getElementById('treeDiagram');
            const currentTransform = diagram.style.transform;

            // ìŠ¤ì¼€ì¼ ê°’ ì¶”ì¶œ (ê¸°ë³¸ê°’ 1)
            let scale = 1;
            if (currentTransform && currentTransform.includes('scale')) {
                const scaleMatch = currentTransform.match(/scale\(([\d.]+)\)/);
                if (scaleMatch) {
                    scale = parseFloat(scaleMatch[1]);
                }
            }

            // ìš”ì†Œì˜ ìƒëŒ€ì  ìœ„ì¹˜ ê³„ì‚° (ë‹¤ì´ì–´ê·¸ë¨ ê¸°ì¤€)
            const diagramRect = diagram.getBoundingClientRect();
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();

            // ë‹¤ì´ì–´ê·¸ë¨ ë‚´ë¶€ ì¢Œí‘œë¡œ ë³€í™˜
            const x1 = (fromRect.left - diagramRect.left) / scale + fromRect.width / (2 * scale);
            const y1 = (fromRect.bottom - diagramRect.top) / scale;
            const x2 = (toRect.left - diagramRect.left) / scale + toRect.width / (2 * scale);
            const y2 = (toRect.top - diagramRect.top) / scale;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${x1} ${y1} C ${x1} ${y1 + 30}, ${x2} ${y2 - 30}, ${x2} ${y2}`;
            path.setAttribute('d', d);
            path.setAttribute('class', 'tree-path');
            path.setAttribute('id', `path-${fromId}-${toId}`);

            svg.appendChild(path);
        }

        // ë°ì´í„° ì €ì¥
        function saveData() {
            localStorage.setItem('reactorSurveyData', JSON.stringify(systemData));
            alert('âœ… ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;

            // ì—…ì²´ëª…ì´ ìˆìœ¼ë©´ íŒŒì¼ëª…ì— í¬í•¨, ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ëª… ì‚¬ìš©
            const companyName = systemData.companyInfo.companyName || 'í˜„ì¥ì¡°ì‚¬';
            const dateStr = new Date().toISOString().slice(0,10);
            link.download = `${companyName}_í˜„ì¥ì¡°ì‚¬_${dateStr}.json`;
            link.click();
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // systemData ì—…ë°ì´íŠ¸
                        systemData = importedData;

                        // ì¹´ìš´í„° ë³€ìˆ˜ë“¤ë„ ì—…ë°ì´íŠ¸ (ìˆëŠ” ê²½ìš°)
                        if (importedData.transformerCounter !== undefined) {
                            transformerCounter = importedData.transformerCounter;
                        }
                        if (importedData.mccCounter !== undefined) {
                            mccCounter = importedData.mccCounter;
                        }
                        if (importedData.loadCounter !== undefined) {
                            loadCounter = importedData.loadCounter;
                        }

                        // UI ì „ì²´ ì—…ë°ì´íŠ¸
                        updateStatistics();
                        updateProgress();

                        // íŠ¸ë¦¬ êµ¬ì¡° ì¬êµ¬ì„±
                        rebuildTreeFromData();

                        // ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                        setTimeout(() => {
                            redrawConnections();
                        }, 100);

                        // ëª¨ë“  ë…¸ë“œì˜ ì‚¬ì§„ í‘œì‹œ ì—…ë°ì´íŠ¸
                        ['kepco', 'transformers', 'panels', 'loads'].forEach(nodeType => {
                            if (nodeType === 'kepco') {
                                if (systemData.kepco.images && systemData.kepco.images.length > 0) {
                                    updatePhotoDisplay('kepco');
                                }
                            } else {
                                Object.keys(systemData[nodeType] || {}).forEach(nodeId => {
                                    if (systemData[nodeType][nodeId].images && systemData[nodeType][nodeId].images.length > 0) {
                                        updatePhotoDisplay(nodeId);
                                    }
                                });
                            }
                        });

                        alert('âœ… JSON ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');

                    } catch (err) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', err);
                        alert('âŒ JSON íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ìë™ ê³„ì‚°
        function autoCalculate() {
            // ë³€ì••ê¸° ë¶€í•˜ìœ¨ ìë™ ê³„ì‚°
            Object.keys(systemData.transformers).forEach(trId => {
                const connectedPanels = systemData.connections.transformerToPanels[trId] || [];
                let totalLoad = 0;
                
                connectedPanels.forEach(panelId => {
                    const connectedLoads = systemData.connections.panelToLoads[panelId] || [];
                    connectedLoads.forEach(loadId => {
                        const load = systemData.loads[loadId];
                        if (load) {
                            totalLoad += load.capacity * load.quantity * (load.loadRate / 100);
                        }
                    });
                });
                
                const tr = systemData.transformers[trId];
                tr.loadRate = Math.min(100, Math.round(totalLoad / tr.capacity * 100));
            });
            
            updateStatistics();
            alert('âœ… ìë™ ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì´ˆê¸°í™”
        function resetAll() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                systemData = {
                    kepco: {
                        voltage: '22.9kV',
                        contractPower: 0,
                        receptionType: '',
                        vcb: '',
                        status: 'empty'
                    },
                    transformers: {},
                    panels: {},
                    loads: {},
                    images: {},
                    connections: {
                        transformerToPanels: {},
                        panelToLoads: {}
                    }
                };
                
                transformerCounter = 0;
                mccCounter = 0;
                loadCounter = 0;
                
                location.reload();
            }
        }

        // ì¸ë„¤ì¼ ìƒì„± í•¨ìˆ˜
        function createThumbnail(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // ì¸ë„¤ì¼ í¬ê¸° ì„¤ì • (400x300 ìµœëŒ€, ë¹„ìœ¨ ìœ ì§€)
                    const MAX_WIDTH = 400;
                    const MAX_HEIGHT = 300;

                    let width = img.width;
                    let height = img.height;

                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë¦¬ì‚¬ì´ì¦ˆ
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = (MAX_WIDTH / width) * height;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = (MAX_HEIGHT / height) * width;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // JPEG í’ˆì§ˆ 60% (ì¸ë„¤ì¼ìš©)
                    const thumbnail = canvas.toDataURL('image/jpeg', 0.6);
                    callback(thumbnail);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ì‚¬ì§„ ì´¬ì˜ ê¸°ëŠ¥ (ì¸ë„¤ì¼ ë°©ì‹)
        function addPhoto(nodeId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'camera';
            input.style.display = 'none';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // ì¸ë„¤ì¼ ìƒì„±
                    createThumbnail(file, (thumbnailData) => {
                        // í˜„ì¬ ì‹œê°„ì„ YYYYMMDD_HHMMSS í˜•ì‹ìœ¼ë¡œ
                        const now = new Date();
                        const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);

                        // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ systemDataì— ì €ì¥ (ì¸ë„¤ì¼ + ë©”íƒ€ë°ì´í„°)
                        if (!systemData.images[nodeId]) {
                            systemData.images[nodeId] = [];
                        }

                        systemData.images[nodeId].push({
                            thumbnail: thumbnailData,           // ì¸ë„¤ì¼ (30-50KB)
                            originalName: file.name,            // ì›ë³¸ íŒŒì¼ëª…
                            timestamp: now.toISOString(),       // ISO í˜•ì‹ ì‹œê°„
                            displayTime: now.toLocaleString(),  // í™”ë©´ í‘œì‹œìš© ì‹œê°„
                            size: Math.round(file.size / 1024) + 'KB', // ì›ë³¸ í¬ê¸°
                            nodeId: nodeId                      // ë…¸ë“œ ID ì°¸ì¡°
                        });

                        alert(`ğŸ“¸ ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nì›ë³¸: ${file.name} (${Math.round(file.size/1024)}KB)\nì¸ë„¤ì¼ë¡œ ì €ì¥ë¨`);
                        updatePhotoDisplay(nodeId);
                        updateDetailPhotoDisplay(nodeId);
                        redrawConnections(); // ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    });
                }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        // ì‚¬ì§„ í‘œì‹œ ì—…ë°ì´íŠ¸ (íŠ¸ë¦¬ ë…¸ë“œìš©)
        function updatePhotoDisplay(nodeId) {
            const photoContainer = document.getElementById(`photos-${nodeId}`);
            if (!photoContainer) return;

            photoContainer.innerHTML = '';
            const images = systemData.images[nodeId] || [];

            images.forEach((img, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = img.thumbnail || img.data; // ì¸ë„¤ì¼ ìš°ì„ , ê¸°ì¡´ data í˜¸í™˜
                imgElement.style.cssText = 'width: 40px; height: 40px; object-fit: cover; margin: 2px; border-radius: 4px; cursor: pointer;';
                imgElement.title = `${img.originalName || 'photo'} (${img.displayTime || ''})`;
                imgElement.onclick = () => viewFullImage(img.thumbnail || img.data);
                photoContainer.appendChild(imgElement);
            });

            // DOM ë³€ê²½ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            setTimeout(() => {
                redrawConnections();
            }, 50);
        }

        // ìƒì„¸ íŒ¨ë„ì—ì„œ ì‚¬ì§„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateDetailPhotoDisplay(nodeId) {
            const detailPhotoContainer = document.getElementById(`detail-photos-${nodeId}`);
            if (!detailPhotoContainer) return;

            detailPhotoContainer.innerHTML = '';
            const images = systemData.images[nodeId] || [];

            if (images.length === 0) {
                detailPhotoContainer.innerHTML = '<div style="color: #666; font-size: 12px; padding: 10px;">ì´¬ì˜ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            images.forEach((img, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.style.cssText = 'display: inline-block; position: relative; margin: 4px; background: #f8f8f8; border-radius: 8px; padding: 4px;';

                const imgElement = document.createElement('img');
                imgElement.src = img.thumbnail || img.data; // ì¸ë„¤ì¼ ìš°ì„ , ê¸°ì¡´ data í˜¸í™˜
                imgElement.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #ddd;';
                imgElement.title = `ì›ë³¸: ${img.originalName || 'photo'}\ní¬ê¸°: ${img.size || 'unknown'}\nì´¬ì˜: ${img.displayTime || ''}`;
                imgElement.onclick = () => viewFullImage(img.thumbnail || img.data);

                // ì‚¬ì§„ ì •ë³´ í‘œì‹œ
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'font-size: 10px; color: #666; text-align: center; margin-top: 2px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                infoDiv.textContent = img.originalName || `Photo ${index + 1}`;
                infoDiv.title = `ì›ë³¸: ${img.originalName || 'photo'}\ní¬ê¸°: ${img.size || 'unknown'}\nì´¬ì˜: ${img.displayTime || ''}`;

                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.style.cssText = `
                    position: absolute; top: -2px; right: -2px; width: 18px; height: 18px;
                    border-radius: 50%; background: #f44336; color: white; border: none;
                    cursor: pointer; font-size: 12px; display: flex; align-items: center;
                    justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deletePhoto(nodeId, index);
                };

                imgWrapper.appendChild(imgElement);
                imgWrapper.appendChild(infoDiv);
                imgWrapper.appendChild(deleteBtn);
                detailPhotoContainer.appendChild(imgWrapper);
            });

            // DOM ë³€ê²½ í›„ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            setTimeout(() => {
                redrawConnections();
            }, 50);
        }

        // ì‚¬ì§„ ì‚­ì œ
        function deletePhoto(nodeId, index) {
            if (confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                systemData.images[nodeId].splice(index, 1);
                updatePhotoDisplay(nodeId);
                updateDetailPhotoDisplay(nodeId);
                redrawConnections(); // ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                alert('ğŸ“¸ ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì²´ ì´ë¯¸ì§€ ë³´ê¸°
        function viewFullImage(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
                justify-content: center; align-items: center; cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';

            modal.appendChild(img);
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }


        // ì €ì¥ëœ ë°ì´í„°ë¡œë¶€í„° íŠ¸ë¦¬ ì¬êµ¬ì„±

        // ì—…ì²´ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
        function openCompanyInfo() {
            const modal = document.getElementById('companyInfoModal');

            // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
            if (systemData.companyInfo) {
                document.getElementById('companyName').value = systemData.companyInfo.name || '';
                document.getElementById('companyAddress').value = systemData.companyInfo.address || '';
                document.getElementById('companyContact').value = systemData.companyInfo.contact || '';
                document.getElementById('companyManager').value = systemData.companyInfo.manager || '';
                document.getElementById('surveyDate').value = systemData.companyInfo.surveyDate || '';
                document.getElementById('contractDate').value = systemData.companyInfo.contractDate || '';
                document.getElementById('companyNotes').value = systemData.companyInfo.notes || '';
            }

            modal.style.display = 'block';
        }

        // ì—…ì²´ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        function closeCompanyInfo() {
            document.getElementById('companyInfoModal').style.display = 'none';
        }

        // ì—…ì²´ì •ë³´ ì €ì¥
        function saveCompanyInfo() {
            systemData.companyInfo = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                contact: document.getElementById('companyContact').value,
                manager: document.getElementById('companyManager').value,
                surveyDate: document.getElementById('surveyDate').value,
                contractDate: document.getElementById('contractDate').value,
                notes: document.getElementById('companyNotes').value
            };

            alert('âœ… ì—…ì²´ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeCompanyInfo();

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStatistics();
        }

        function rebuildTreeFromData() {
            // íŠ¸ë¦¬ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            const treeView = document.getElementById('treeView');
            if (!treeView) return;

            // ê¸°ì¡´ ë…¸ë“œë“¤ ì œê±° (KEPCOì™€ í†µê³„ ì¹´ë“œëŠ” ìœ ì§€)
            const existingNodes = treeView.querySelectorAll('.tree-node:not(#kepco)');
            existingNodes.forEach(node => node.remove());

            // KEPCO ìˆ˜ì „ ì •ë³´ ì—…ë°ì´íŠ¸
            let kepcoNode = document.getElementById('kepco');
            if (kepcoNode && systemData.kepco) {
                // ê¸°ì¡´ KEPCO ë…¸ë“œ ì—…ë°ì´íŠ¸
                const nodeInfo = kepcoNode.querySelector('.node-info');
                const nodeStatus = kepcoNode.querySelector('.node-status');

                if (nodeInfo) {
                    nodeInfo.textContent = `${systemData.kepco.voltage} / ${systemData.kepco.contractPower}kW`;
                }
                if (nodeStatus) {
                    nodeStatus.className = `node-status ${systemData.kepco.status || 'empty'}`;
                    nodeStatus.textContent = systemData.kepco.status === 'completed' ? 'ì™„ë£Œ' :
                                            systemData.kepco.status === 'incomplete' ? 'ì§„í–‰ì¤‘' : '-';
                }
            }

            // ë³€ì••ê¸° ë…¸ë“œë“¤ ì¬ìƒì„±
            Object.values(systemData.transformers || {}).forEach(transformer => {
                addTransformerNode(transformer.id);
            });

            // MCC ë…¸ë“œë“¤ ì¬ìƒì„±
            Object.values(systemData.panels || {}).forEach(panel => {
                addMCCNode(panel.id);
            });

            // ë¶€í•˜ ë…¸ë“œë“¤ ì¬ìƒì„±
            Object.values(systemData.loads || {}).forEach(load => {
                addLoadNode(load.id);
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStatistics();

            // ì—…ì²´ ì •ë³´ê°€ ìˆìœ¼ë©´ ì œëª© ì—…ë°ì´íŠ¸
            if (systemData.companyInfo && systemData.companyInfo.name) {
                const headerH1 = document.querySelector('.header h1');
                if (headerH1) {
                    headerH1.textContent = `âš¡ ì›ì„¸ì´ë²„ìŠ¤ ë¦¬ì•¡í„° ì„¤ì¹˜ í†µí•© ì¡°ì‚¬ ì‹œìŠ¤í…œ - ${systemData.companyInfo.name}`;
                }
            }
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜ í•¨ìˆ˜
        function getStatusText(status) {
            switch (status) {
                case 'completed': return 'ì™„ë£Œ';
                case 'incomplete': return 'ì§„í–‰ì¤‘';
                default: return 'ë¯¸ì™„ë£Œ';
            }
        }

        // ë³´ê³ ì„œ ìƒì„±
        function generateReport() {
            let report = '=== ë¦¬ì•¡í„° ì„¤ì¹˜ í˜„ì¥ì¡°ì‚¬ ë³´ê³ ì„œ ===\n\n';
            report += `ì¡°ì‚¬ì¼: ${new Date().toLocaleDateString()}\n\n`;

            report += '1. ìˆ˜ì „ì„¤ë¹„\n';
            report += `   - ìˆ˜ì „ì „ì••: ${systemData.kepco.voltage}\n`;
            report += `   - ê³„ì•½ì „ë ¥: ${systemData.kepco.contractPower}kW\n`;
            report += `   - ìˆ˜ì „ë°©ì‹: ${systemData.kepco.receptionType}\n\n`;

            report += '2. ë³€ì••ê¸° í˜„í™©\n';
            Object.values(systemData.transformers).forEach(tr => {
                report += `   - ${tr.title}: ${tr.capacity}kVA (ë¶€í•˜ìœ¨ ${tr.loadRate}%)\n`;
            });

            report += '\n3. ê¶Œì¥ ë¦¬ì•¡í„° ìš©ëŸ‰\n';
            report += `   - ${document.getElementById('recommendedReactor').textContent}kVar\n`;

            alert(report);
        }

        // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
        function toggleMobileMenu() {
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const dropdown = document.getElementById('mobileMenuDropdown');

            hamburgerBtn.classList.toggle('active');
            dropdown.classList.toggle('active');
        }

        // ëª¨ë°”ì¼ ë©”ë‰´ ë‹«ê¸° í•¨ìˆ˜
        function closeMobileMenu() {
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const dropdown = document.getElementById('mobileMenuDropdown');

            hamburgerBtn.classList.remove('active');
            dropdown.classList.remove('active');
        }

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const mobileMenuContainer = document.querySelector('.mobile-menu-container');
            const dropdown = document.getElementById('mobileMenuDropdown');

            if (mobileMenuContainer && !mobileMenuContainer.contains(event.target) && dropdown && dropdown.classList.contains('active')) {
                closeMobileMenu();
            }
        });

        // ì‚¬ì§„ ëŒ€ì¡°í‘œ ìƒì„± í•¨ìˆ˜
        function generatePhotoIndex() {
            const allPhotos = [];

            // ê° ë…¸ë“œì˜ ì‚¬ì§„ ìˆ˜ì§‘
            ['kepco', 'transformers', 'panels', 'loads'].forEach(nodeType => {
                const nodes = nodeType === 'kepco' ? [systemData.kepco] : Object.values(systemData[nodeType]);

                nodes.forEach(node => {
                    if (node.images && node.images.length > 0) {
                        node.images.forEach((photo, index) => {
                            allPhotos.push({
                                nodeId: node.id || 'kepco',
                                nodeTitle: node.title || node.id || 'KEPCO ìˆ˜ì „',
                                photoIndex: index + 1,
                                originalName: photo.originalName || 'ì‚¬ì§„' + (index + 1),
                                timestamp: photo.timestamp || new Date().toISOString(),
                                displayTime: photo.displayTime || new Date(photo.timestamp).toLocaleString(),
                                size: photo.size || 'Unknown'
                            });
                        });
                    }
                });
            });

            if (allPhotos.length === 0) {
                alert('ì €ì¥ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // CSV ìƒì„±
            let csvContent = 'ë²ˆí˜¸,ë…¸ë“œ,ì‚¬ì§„ë²ˆí˜¸,ì›ë³¸íŒŒì¼ëª…,ì´¬ì˜ì‹œê°„,íŒŒì¼í¬ê¸°\n';
            allPhotos.forEach((photo, index) => {
                csvContent += `${index + 1},${photo.nodeTitle},${photo.photoIndex},${photo.originalName},${photo.displayTime},${photo.size}\n`;
            });

            // CSV ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ì‚¬ì§„ëŒ€ì¡°í‘œ.csv';
            a.click();
            URL.revokeObjectURL(url);

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            showPhotoIndexPreview(allPhotos);
        }

        // ì‚¬ì§„ ëŒ€ì¡°í‘œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showPhotoIndexPreview(photos) {
            let previewHtml = '<div style="max-height: 500px; overflow-y: auto; margin-top: 20px;">';
            previewHtml += '<h3>ğŸ“‹ ì‚¬ì§„ ëŒ€ì¡°í‘œ ë¯¸ë¦¬ë³´ê¸°</h3>';
            previewHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            previewHtml += '<tr style="background: #f0f0f0; font-weight: bold;">';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">ë²ˆí˜¸</th>';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">ë…¸ë“œ</th>';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">ì‚¬ì§„ë²ˆí˜¸</th>';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">ì›ë³¸íŒŒì¼ëª…</th>';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">ì´¬ì˜ì‹œê°„</th>';
            previewHtml += '<th style="border: 1px solid #ddd; padding: 8px;">íŒŒì¼í¬ê¸°</th>';
            previewHtml += '</tr>';

            photos.forEach((photo, index) => {
                previewHtml += '<tr>';
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${index + 1}</td>`;
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px;">${photo.nodeTitle}</td>`;
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${photo.photoIndex}</td>`;
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px;">${photo.originalName}</td>`;
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px;">${photo.displayTime}</td>`;
                previewHtml += `<td style="border: 1px solid #ddd; padding: 6px;">${photo.size}</td>`;
                previewHtml += '</tr>';
            });

            previewHtml += '</table>';
            previewHtml += '<p style="margin-top: 15px; color: #666; font-size: 11px;">';
            previewHtml += 'ğŸ’¡ ì´ ëŒ€ì¡°í‘œë¥¼ ì‚¬ìš©í•´ ì¸ë„¤ì¼ê³¼ ì›ë³¸ ì‚¬ì§„ì„ ë§¤ì¹­í•˜ì„¸ìš”.<br>';
            previewHtml += 'ğŸ“‚ ì›ë³¸ ì‚¬ì§„ë“¤ì€ ë³„ë„ë¡œ ë³´ê´€í•˜ê³  í•„ìš”ì‹œ ëŒ€ì¡°í‘œë¥¼ ì°¸ê³ í•˜ì—¬ ì°¾ìœ¼ì„¸ìš”.';
            previewHtml += '</p>';
            previewHtml += '</div>';

            // ìƒˆ ì°½ì—ì„œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            const htmlContent = '<html>' +
                '<head>' +
                '<title>ì‚¬ì§„ ëŒ€ì¡°í‘œ ë¯¸ë¦¬ë³´ê¸°</title>' +
                '<meta charset="UTF-8">' +
                '</head>' +
                '<body style="font-family: Arial, sans-serif; margin: 20px;">' +
                previewHtml +
                '<div style="margin-top: 20px; text-align: center;">' +
                '<button onclick="window.close()" style="padding: 10px 20px; font-size: 14px;">ì°½ ë‹«ê¸°</button>' +
                '</div>' +
                '</body>' +
                '</html>';
            newWindow.document.write(htmlContent);
            newWindow.document.close();

            alert('âœ… ì‚¬ì§„ ëŒ€ì¡°í‘œ CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆê³ , ë¯¸ë¦¬ë³´ê¸° ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!');
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            updateStatistics();

            // SVG í¬ê¸° ì„¤ì •
            setTimeout(() => {
                const diagram = document.getElementById('treeDiagram');
                const svg = document.getElementById('treeSvg');
                if (diagram && svg) {
                    svg.setAttribute('width', diagram.offsetWidth);
                    svg.setAttribute('height', diagram.offsetHeight);
                }
            }, 100);
        });

        // ì°½ í¬ê¸° ë³€ê²½ì‹œ ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸° ë° ìŠ¤ì¼€ì¼ ì¡°ì •
        window.addEventListener('resize', () => {
            if (typeof redrawConnections === 'function') {
                redrawConnections();
            }
            // ìë™ ìŠ¤ì¼€ì¼ ì¡°ì •
            setTimeout(() => {
                autoScaleTree();
            }, 100);
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetail();
                if (typeof closeModal === 'function') closeModal();
                if (typeof cancelDelete === 'function') cancelDelete();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (typeof saveData === 'function') saveData();
            }
        });
    </script>
</body>
</html>
